name: Issue Management Automation
on:
  issues:
    types: [opened, labeled]

permissions:
  contents: read
  issues: write

jobs:
  setup-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Create required labels
        uses: actions/github-script@v7
        with:
          script: |
            const requiredLabels = [
              // Category Labels
              { name: "bug", description: "Something isn't working" },
              { name: "enhancement", description: "New feature or request" },
              { name: "epic", description: "Large feature requiring multiple sub-tasks" },
              { name: "maintenance", description: "Maintenance and housekeeping tasks" },
              // Priority Labels
              { name: "priority-critical", description: "Critical priority issue" },
              { name: "priority-high", description: "High priority issue" },
              { name: "priority-medium", description: "Medium priority issue" },
              { name: "priority-low", description: "Low priority issue" },
              // Status Labels
              { name: "needs-triage", description: "Needs to be reviewed by maintainers" },
              { name: "needs-review", description: "Awaiting review from maintainers" },
              { name: "first-time-contributor", description: "Issue created by first-time contributor" }
            ];

            for (const label of requiredLabels) {
              try {
                // Check if label exists
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });
                console.log(`Label "${label.name}" already exists.`);
              } catch (error) {
                if (error.status === 404) {
                  // Create label if it doesn't exist
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    description: label.description,
                    color: "ffffff"
                  });
                  console.log(`Created label "${label.name}".`);
                } else {
                  console.error(`Error handling label "${label.name}":`, error);
                }
              }
            }

  issue-triage:
    runs-on: ubuntu-latest
    needs: setup-labels
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Triage issue (add category/priority labels)
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body ? issue.body.toLowerCase() : "";

            // Initialize labels with "needs-triage"
            let labelsToAdd = ["needs-triage"];

            // Add category labels based on title
            if (title.includes("bug")) labelsToAdd.push("bug");
            if (title.includes("epic")) labelsToAdd.push("epic");
            if (title.includes("maintenance")) labelsToAdd.push("maintenance");

            // Add priority labels (highest priority first)
            const priorityRules = [
              { keywords: ["critical", "urgent", "production", "outage"], label: "priority-critical" },
              { keywords: ["important", "high", "blocking"], label: "priority-high" },
              { keywords: ["medium", "normal"], label: "priority-medium" },
              { keywords: ["low", "nice-to-have", "minor"], label: "priority-low" }
            ];

            let priorityLabel = "priority-medium"; // Default
            for (const rule of priorityRules) {
              const hasKeyword = rule.keywords.some(kw => title.includes(kw) || body.includes(kw));
              if (hasKeyword) {
                priorityLabel = rule.label;
                break;
              }
            }
            labelsToAdd.push(priorityLabel);

            // Remove duplicate labels
            labelsToAdd = [...new Set(labelsToAdd)];

            // Add labels to issue
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labelsToAdd
            });

  task-breakdown:
    runs-on: ubuntu-latest
    needs: issue-triage
    if: contains(github.event.issue.labels.*.name, 'epic')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Create epic subtasks
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const parentIssueNumber = issue.number;
            const parentTitle = issue.title;

            // Define subtasks
            const subtasks = [
              { number: 1, name: "Requirements Analysis" },
              { number: 2, name: "Design and Architecture" },
              { number: 3, name: "Implementation" },
              { number: 4, name: "Testing and Documentation" }
            ];

            // Create subtasks and collect their numbers
            const subtaskNumbers = [];
            for (const task of subtasks) {
              const subtaskTitle = `[SUBTASK] ${parentTitle} - Task ${task.number}: ${task.name}`;
              const subtaskBody = `Related to #${parentIssueNumber}`;
              const subtaskLabels = ["enhancement", "needs-review"];

              // Create subtask
              const subtaskResponse = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: subtaskTitle,
                body: subtaskBody,
                labels: subtaskLabels
              });

              subtaskNumbers.push(subtaskResponse.data.number);
            }

            // Update parent issue with Epic Tasks checklist
            const checklistItems = subtaskNumbers.map(num => `- [ ] #${num}`).join("\n");
            const updatedParentBody = `${issue.body || ""}\n\n## Epic Tasks\n${checklistItems}`;

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parentIssueNumber,
              body: updatedParentBody
            });

  auto-response:
    runs-on: ubuntu-latest
    needs: issue-triage
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Auto-response and issue updates
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            const issueNumber = issue.number;
            const authorLogin = issue.user.login;

            // 1. Check if author is first-time contributor to this repo
            let isFirstIssue = false;
            try {
              const authorIssues = await github.rest.issues.listForRepo({
                owner: repoOwner,
                repo: repoName,
                creator: authorLogin,
                state: "all"
              });
              isFirstIssue = authorIssues.data.length === 1; // Only this issue exists
            } catch (error) {
              console.error("Error checking first-time contributor:", error);
              isFirstIssue = false;
            }

            // 2. Add first-time-contributor label if needed
            if (isFirstIssue) {
              await github.rest.issues.addLabels({
                owner: repoOwner,
                repo: repoName,
                issue_number: issueNumber,
                labels: ["first-time-contributor"]
              });
            }

            // 3. Determine comment content based on issue type
            const issueLabels = issue.labels.map(l => l.name);
            let commentBody = "";

            if (issueLabels.includes("bug")) {
              commentBody = "Thank you for reporting this bug! Please refer to our [Bug Report Guidelines](.github/ISSUE_TEMPLATE/bug_report.md) for additional details you may need to provide.";
            } else if (issueLabels.includes("epic")) {
              commentBody = "Thank you for submitting this epic! Please refer to our [Feature Request Process](.github/ISSUE_TEMPLATE/feature_request.md) for guidance on how we process large feature requests.";
            } else if (issueLabels.includes("maintenance")) {
              commentBody = "Thank you for submitting this maintenance task! Please refer to our [Maintenance Guidelines](.github/ISSUE_TEMPLATE/maintenance_report.md) for details on how we handle maintenance work.";
            }

            // Add welcome message if first-time contributor
            if (isFirstIssue) {
              commentBody = `Welcome to the repository, @${authorLogin}! This is your first issue here. ${commentBody}`;
            }

            // 4. Post comment if there's content
            if (commentBody) {
              await github.rest.issues.createComment({
                owner: repoOwner,
                repo: repoName,
                issue_number: issueNumber,
                body: commentBody
              });
            }

            // 5. Set milestone for high/critical priority issues
            if (issueLabels.includes("priority-high") || issueLabels.includes("priority-critical")) {
              // Find or create v1.0.0 milestone
              let milestoneId = null;
              try {
                const milestones = await github.rest.issues.listMilestones({
                  owner: repoOwner,
                  repo: repoName,
                  state: "open"
                });
                const v1Milestone = milestones.data.find(m => m.title === "v1.0.0");

                if (v1Milestone) {
                  milestoneId = v1Milestone.number;
                } else {
                  // Create milestone if it doesn't exist
                  const newMilestone = await github.rest.issues.createMilestone({
                    owner: repoOwner,
                    repo: repoName,
                    title: "v1.0.0",
                    state: "open"
                  });
                  milestoneId = newMilestone.data.number;
                }
              } catch (error) {
                console.error("Error handling milestone:", error);
              }

              if (milestoneId) {
                await github.rest.issues.update({
                  owner: repoOwner,
                  repo: repoName,
                  issue_number: issueNumber,
                  milestone: milestoneId
                });
              }
            }

            // 6. Update status: remove needs-triage, add needs-review
            await github.rest.issues.removeLabel({
              owner: repoOwner,
              repo: repoName,
              issue_number: issueNumber,
              name: "needs-triage"
            });
            await github.rest.issues.addLabels({
              owner: repoOwner,
              repo: repoName,
              issue_number: issueNumber,
              labels: ["needs-review"]
            });
